<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ú¯Ø²Ø§Ø±Ø´ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ - Ú©Ø§ÙÙ‡ ØªØ±Ø§Ø³</title>
  <style>
    body { font-family: sans-serif; background: #ffecb3; padding: 16px; }
    h2 { text-align: center; color: #1A237E; margin-bottom: 8px;}
    #reportModal { background: #fff; border-radius: 12px; padding: 20px; max-width: 1000px; margin: auto; }
    select, input { padding: 8px; border-radius: 6px; border: 1px solid #ccc; margin: 4px; }
    button { background: #1A237E; color: white; border: none; border-radius: 8px; padding: 8px 14px; margin: 6px; cursor: pointer; }
    .shift-header { background: #1A237E; color: #fff; padding: 8px 12px; border-radius: 8px; margin-top: 12px; font-weight: bold; }
    .report-item { background: #f7f7f7; border-radius: 8px; padding: 10px; margin-top: 8px; }
    .total-report { font-weight: bold; margin-top: 8px; color: #1A237E; }
    .controls { display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-start; margin-bottom:10px; }
    .small-btn { padding:6px 10px; border-radius:6px; background:#4CAF50; color:#fff; border:none; cursor:pointer; }
    .delete-btn { background:#D32F2F; color:#fff; border:none; border-radius:6px; padding:6px 10px; cursor:pointer; }
    pre { white-space: pre-wrap; font-family: inherit; }
    @media (max-width:600px){
      .controls { flex-direction:column; align-items:stretch; }
    }
  </style>
</head>
<body>
  <h2>ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ - Ú©Ø§ÙÙ‡ ØªØ±Ø§Ø³</h2>

  <div id="reportModal">
    <div class="controls">
      <label for="dateFilter">ØªØ§Ø±ÛŒØ® (Ø§Ù†ØªØ®Ø§Ø¨ Ú†Ù†Ø¯ØªØ§ÛŒÛŒ):</label>
      <select id="dateFilter" multiple onchange="renderReport()" style="min-width:200px"></select>

      <input type="text" id="searchBox" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± ØªÙˆØ¶ÛŒØ­Ø§Øª ÙØ§Ú©ØªÙˆØ±Ù‡Ø§..." oninput="renderReport()" style="min-width:220px" />

      <button id="refreshBtn" class="small-btn">Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
      <button id="showAllBtn" class="small-btn" onclick="clearFilters()">Ù†Ù…Ø§ÛŒØ´ ØªÙ…Ø§Ù… ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§</button>
    </div>

    <div id="reportContent"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getDatabase, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

    // ---------- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Firebase ----------
    const firebaseConfig = {
      apiKey: "AIzaSyAw0vcOTv4fYOlvQrWhzYEiWwykkd3FmuQ",
      authDomain: "cafeterrasapp.firebaseapp.com",
      databaseURL: "https://cafeterrasapp-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "cafeterrasapp",
      storageBucket: "cafeterrasapp.appspot.com",
      messagingSenderId: "574400800164",
      appId: "1:574400800164:web:fc4bd509e158a6fbeecd31"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const ordersRef = ref(db, "orders");

    // ---------- Ø§Ù„Ù…Ø§Ù†â€ŒÙ‡Ø§ ----------
    const dateFilter = document.getElementById("dateFilter");
    const searchBox = document.getElementById("searchBox");
    const reportContent = document.getElementById("reportContent");
    const refreshBtn = document.getElementById("refreshBtn");

    // ---------- ØªØ¨Ø¯ÛŒÙ„ Ø§Ø±Ù‚Ø§Ù… ÙØ§Ø±Ø³ÛŒ Ø¨Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ ----------
    function persianToEnglishDigits(str) {
      if (!str && str !== "") return str;
      const persian = "Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹";
      const english = "0123456789";
      return String(str).split("").map(ch => {
        const idx = persian.indexOf(ch);
        return idx >= 0 ? english[idx] : ch;
      }).join("");
    }

    // ---------- ØªØ¨Ø¯ÛŒÙ„ Ø²Ù…Ø§Ù† ÙØ§Ø±Ø³ÛŒ "Û±Û¹:Û´Û±:Û±Û³" Ø¨Ù‡ Ø¯Ù‚ÛŒÙ‚Ù‡ Ø§Ø² Ø´Ø±ÙˆØ¹ Ø±ÙˆØ² ----------
    function timeStringToMinutes(timeStr) {
      if (!timeStr) return null;
      // Ù…Ù…Ú©Ù†Ù‡ Ú©Ø§Ø±Ø§Ú©ØªØ±Ù‡Ø§ÛŒ ÙØ§ØµÙ„Ù‡ ÛŒØ§ ÙØ§Ø±Ø³ÛŒ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ù‡ØŒ ØªÙ…Ø§Ù… Ø§Ø±Ù‚Ø§Ù… Ø±Ùˆ Ø¨Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ ØªØ¨Ø¯ÛŒÙ„ Ú©Ù†
      const cleaned = persianToEnglishDigits(timeStr.trim());
      const parts = cleaned.split(":");
      if (parts.length < 2) return null;
      const h = parseInt(parts[0], 10);
      const m = parseInt(parts[1], 10) || 0;
      return (isNaN(h) || isNaN(m)) ? null : (h * 60 + m);
    }

    // ---------- ØªØ¹ÛŒÛŒÙ† Ø´ÛŒÙØª Ø¨Ø±Ø§Ø³Ø§Ø³ Ø¯Ù‚ÛŒÙ‚Ù‡ Ø§Ø² Ø±ÙˆØ² ----------
    // ØªØ¹Ø±ÛŒÙ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø±: Ø´ÛŒÙØª ØµØ¨Ø­ = 09:00 ØªØ§ 16:59 (9*60 .. <17*60)
    // Ø´ÛŒÙØª Ø´Ø¨ = 00:00 ØªØ§ 02:59 Ùˆ 17:00 ØªØ§ 23:59 Ù‡Ù…Ø§Ù† Ø±ÙˆØ²
    function getShiftFromTimeStr(timeStr) {
      const minutes = timeStringToMinutes(timeStr);
      if (minutes === null) return null;
      if (minutes >= 9 * 60 && minutes < 17 * 60) return "Ø´ÛŒÙØª ØµØ¨Ø­";
      if ((minutes >= 0 && minutes < 3 * 60) || (minutes >= 17 * 60 && minutes <= 23 * 60 + 59)) return "Ø´ÛŒÙØª Ø´Ø¨";
      return null;
    }

    // ---------- Ù¾Ø± Ú©Ø±Ø¯Ù† Ù„ÛŒØ³Øª ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ ----------
    function populateDateFilter() {
      onValue(ordersRef, (snap) => {
        const data = snap.val() || {};
        const dates = new Set();
        Object.values(data).forEach(order => {
          if (order && order.date) dates.add(order.date);
        });
        // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ùˆ Ø§ÙØ²ÙˆØ¯Ù† Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§
        dateFilter.innerHTML = "";
        const sorted = Array.from(dates).sort((a,b) => a < b ? -1 : 1); // ØªØ±ØªÛŒØ¨ Ø±Ø´ØªÙ‡â€ŒØ§ÛŒ Ú©Ø§ÙÛŒ Ø§Ø³Øª Ø¨Ø±Ø§ÛŒ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ Ø¯Ø± ÙØ±Ù…Øª ÛŒÚ©Ù†ÙˆØ§Ø®Øª
        sorted.forEach(d => {
          const opt = document.createElement("option");
          opt.value = d;
          opt.textContent = d;
          dateFilter.appendChild(opt);
        });
      }, { onlyOnce: true });
    }

    // ---------- Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙÛŒÙ„ØªØ±Ù‡Ø§ ----------
    function clearFilters() {
      // Ù„ØºÙˆ Ø§Ù†ØªØ®Ø§Ø¨ Ù‡Ø± Ú¯Ø²ÛŒÙ†Ù‡ Ø¯Ø± select
      for (let i = 0; i < dateFilter.options.length; i++) {
        dateFilter.options[i].selected = false;
      }
      searchBox.value = "";
      renderReport();
    }

    // ---------- Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¬Ù…ÙˆØ¹ ÛŒÚ© ÙØ§Ú©ØªÙˆØ± ----------
    function computeOrderTotal(order) {
      if (!order) return 0;
      let itemsTotal = 0;
      if (order.items) {
        // items Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø´ÛŒØ¡ Ø¨Ø§ Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ ØªØµØ§Ø¯ÙÛŒ Ø¨Ø§Ø´Ø¯
        Object.values(order.items).forEach(it => {
          const qty = Number(it.qty) || 0;
          const price = Number(it.price) || 0;
          itemsTotal += qty * price;
        });
      }
      const extra = Number(order.extra?.amount) || 0;
      const discount = Number(order.discount) || 0;
      return itemsTotal + extra - discount;
    }

    // ---------- Ø±Ù†Ø¯Ø± Ú¯Ø²Ø§Ø±Ø´ ØªÙÚ©ÛŒÚ©ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø´ÛŒÙØªâ€ŒÙ‡Ø§ ----------
    function renderReport() {
      onValue(ordersRef, (snap) => {
        const data = snap.val() || {};
        const selectedDates = Array.from(dateFilter.selectedOptions).map(o => o.value);
        const searchTerm = (searchBox.value || "").trim().toLowerCase();

        // Ø³Ø§Ø®ØªØ§Ø±: grouped[shift][date] = [orders...]
        const grouped = { "Ø´ÛŒÙØª ØµØ¨Ø­": {}, "Ø´ÛŒÙØª Ø´Ø¨": {} };
        let grandMorning = 0, grandNight = 0;

        Object.entries(data).forEach(([key, order]) => {
          if (!order) return;
          const date = order.date; // ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ Ù…Ø«Ù„ "Û±Û´Û°Û´/Û°Ûµ/Û±Û¸"
          const time = order.time; // Ø²Ù…Ø§Ù† ÙØ§Ø±Ø³ÛŒ Ù…Ø«Ù„ "Û±Û¹:Û´Û±:Û±Û³"
          if (!date || !time) return;

          // ÙÛŒÙ„ØªØ± Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ§Ø±ÛŒØ® Ø§Ù†ØªØ®Ø§Ø¨â€ŒØ´Ø¯Ù‡ (Ø§Ú¯Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ù†Ø¯)
          if (selectedDates.length > 0 && !selectedDates.includes(date)) return;

          // Ø¬Ø³ØªØ¬Ùˆ: Ø¯Ø± customerNote (ØªÙˆØ¶ÛŒØ­Ø§Øª) ÛŒØ§ Ø¯Ø± receipt (Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø²) Ù†Ú¯Ø§Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
          const note = (order.customerNote || "").toString().toLowerCase();
          const receipt = (order.receipt || "").toString().toLowerCase();
          if (searchTerm) {
            if (!(note.includes(searchTerm) || receipt.includes(searchTerm))) {
              return; // Ø§Ú¯Ø± Ø´Ø§Ù…Ù„ Ø¬Ø³ØªØ¬Ùˆ Ù†Ø¨ÙˆØ¯ØŒ Ø§Ø² Ù†ØªØ§ÛŒØ¬ Ø­Ø°Ù Ú©Ù†
            }
          }

          const shift = getShiftFromTimeStr(time);
          if (!shift) return;

          if (!grouped[shift][date]) grouped[shift][date] = [];
          grouped[shift][date].push({ key, ...order });
        });

        // Ø­Ø§Ù„Ø§ Ù†Ù…Ø§ÛŒØ´
        reportContent.innerHTML = "";

        // Ø³Ø±Ø¨Ø±Ú¯ Ø´ÛŒÙØª ØµØ¨Ø­
        const morningHeader = document.createElement("div");
        morningHeader.className = "shift-header";
        morningHeader.textContent = "ğŸŒ… Ø´ÛŒÙØª ØµØ¨Ø­ â€” 09:00 ØªØ§ 16:59";
        reportContent.appendChild(morningHeader);

        // Ù‡Ø± ØªØ§Ø±ÛŒØ® Ø¯Ø± Ø´ÛŒÙØª ØµØ¨Ø­
        const morningDates = Object.keys(grouped["Ø´ÛŒÙØª ØµØ¨Ø­"]).sort();
        if (morningDates.length === 0) {
          const p = document.createElement("div"); p.textContent = "ÙØ§Ú©ØªÙˆØ±ÛŒ Ø¯Ø± Ø´ÛŒÙØª ØµØ¨Ø­ ÛŒØ§ÙØª Ù†Ø´Ø¯."; reportContent.appendChild(p);
        }
        morningDates.forEach(date => {
          const list = grouped["Ø´ÛŒÙØª ØµØ¨Ø­"][date];
          let dateTotal = 0;
          list.forEach(order => {
            const total = computeOrderTotal(order);
            dateTotal += total;
            const box = document.createElement("div");
            box.className = "report-item";
            box.innerHTML = `<div><strong>ØªØ§Ø±ÛŒØ®: ${date} â€” Ø²Ù…Ø§Ù†: ${order.time}</strong></div>
                             <pre>${order.receipt || ""}</pre>
                             <div>Ø¬Ù…Ø¹ ÙØ§Ú©ØªÙˆØ±: ${total.toLocaleString()} ØªÙˆÙ…Ø§Ù†</div>
                             <div style="margin-top:6px"><button class="delete-btn" onclick="deleteInvoice('${order.key}')">Ø­Ø°Ù ÙØ§Ú©ØªÙˆØ±</button></div>`;
            reportContent.appendChild(box);
          });
          const sumDiv = document.createElement("div");
          sumDiv.className = "total-report";
          sumDiv.textContent = `Ø¬Ù…Ø¹ ÙØ±ÙˆØ´ ${date} (ØµØ¨Ø­): ${dateTotal.toLocaleString()} ØªÙˆÙ…Ø§Ù†`;
          reportContent.appendChild(sumDiv);
          grandMorning += dateTotal;
        });

        // ÙØ§ØµÙ„Ù‡
        reportContent.appendChild(document.createElement("hr"));

        // Ø³Ø±Ø¨Ø±Ú¯ Ø´ÛŒÙØª Ø´Ø¨
        const nightHeader = document.createElement("div");
        nightHeader.className = "shift-header";
        nightHeader.textContent = "ğŸŒ™ Ø´ÛŒÙØª Ø´Ø¨ â€” 00:00 ØªØ§ 02:59 Ùˆ 17:00 ØªØ§ 23:59 (Ù‡Ù…Ø§Ù† Ø±ÙˆØ²)";
        reportContent.appendChild(nightHeader);

        // Ù‡Ø± ØªØ§Ø±ÛŒØ® Ø¯Ø± Ø´ÛŒÙØª Ø´Ø¨
        const nightDates = Object.keys(grouped["Ø´ÛŒÙØª Ø´Ø¨"]).sort();
        if (nightDates.length === 0) {
          const p = document.createElement("div"); p.textContent = "ÙØ§Ú©ØªÙˆØ±ÛŒ Ø¯Ø± Ø´ÛŒÙØª Ø´Ø¨ ÛŒØ§ÙØª Ù†Ø´Ø¯."; reportContent.appendChild(p);
        }
        nightDates.forEach(date => {
          const list = grouped["Ø´ÛŒÙØª Ø´Ø¨"][date];
          let dateTotal = 0;
          list.forEach(order => {
            const total = computeOrderTotal(order);
            dateTotal += total;
            const box = document.createElement("div");
            box.className = "report-item";
            box.innerHTML = `<div><strong>ØªØ§Ø±ÛŒØ®: ${date} â€” Ø²Ù…Ø§Ù†: ${order.time}</strong></div>
                             <pre>${order.receipt || ""}</pre>
                             <div>Ø¬Ù…Ø¹ ÙØ§Ú©ØªÙˆØ±: ${total.toLocaleString()} ØªÙˆÙ…Ø§Ù†</div>
                             <div style="margin-top:6px"><button class="delete-btn" onclick="deleteInvoice('${order.key}')">Ø­Ø°Ù ÙØ§Ú©ØªÙˆØ±</button></div>`;
            reportContent.appendChild(box);
          });
          const sumDiv = document.createElement("div");
          sumDiv.className = "total-report";
          sumDiv.textContent = `Ø¬Ù…Ø¹ ÙØ±ÙˆØ´ ${date} (Ø´Ø¨): ${dateTotal.toLocaleString()} ØªÙˆÙ…Ø§Ù†`;
          reportContent.appendChild(sumDiv);
          grandNight += dateTotal;
        });

        // Ø¬Ù…Ø¹ Ú©Ù„ Ù‡Ø± Ø´ÛŒÙØª Ùˆ Ù†Ù‡Ø§ÛŒÛŒ
        const separator = document.createElement("div");
        separator.style.marginTop = "12px";
        reportContent.appendChild(separator);

        const totalsBox = document.createElement("div");
        totalsBox.className = "total-report";
        totalsBox.textContent = `Ø¬Ù…Ø¹ Ú©Ù„ ÙØ±ÙˆØ´ â€” ØµØ¨Ø­: ${grandMorning.toLocaleString()} ØªÙˆÙ…Ø§Ù†  |  Ø´Ø¨: ${grandNight.toLocaleString()} ØªÙˆÙ…Ø§Ù†  |  Ù…Ø¬Ù…ÙˆØ¹: ${(grandMorning + grandNight).toLocaleString()} ØªÙˆÙ…Ø§Ù†`;
        reportContent.appendChild(totalsBox);
      }, { onlyOnce: true });
    }

    // ---------- Ø­Ø°Ù ÙØ§Ú©ØªÙˆØ± (Ø§Ø² orders) ----------
    window.deleteInvoice = (key) => {
      if (!confirm("Ø¢ÛŒØ§ Ù…Ø§ÛŒÙ„ Ø¨Ù‡ Ø­Ø°Ù Ø§ÛŒÙ† ÙØ§Ú©ØªÙˆØ± Ù‡Ø³ØªÛŒØ¯ØŸ")) return;
      remove(ref(db, `orders/${key}`))
        .then(() => {
          alert("ÙØ§Ú©ØªÙˆØ± Ø­Ø°Ù Ø´Ø¯.");
          populateDateFilter();
          renderReport();
        })
        .catch(err => {
          console.error(err);
          alert("Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù ÙØ§Ú©ØªÙˆØ±.");
        });
    };

    // ---------- Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ ----------
    refreshBtn.onclick = () => { populateDateFilter(); renderReport(); };
    searchBox.addEventListener("keyup", (e) => {
      // Ø§Ú¯Ø± Ø§ÛŒÙ†ØªØ± Ø²Ø¯ØŒ Ø±Ù†Ø¯Ø± Ù…Ø¬Ø¯Ø¯ Ú©Ù†
      if (e.key === "Enter") renderReport();
    });

    // Ø§Ø¬Ø±Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØµÙØ­Ù‡
    populateDateFilter();
    renderReport();

  </script>
</body>
</html>